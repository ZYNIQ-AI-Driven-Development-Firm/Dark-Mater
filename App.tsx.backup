import React, { useState, useEffect } from 'react';
import LoginPage from './components/LoginPage';
import MainPage from './components/MainPage';
import LoaderPage from './components/LoaderPage';
import LandingPage from './components/LandingPage';
import ErrorBoundary from './components/ErrorBoundary';
import ChatButton from './components/ChatButton';
import ChatWidget from './components/ChatWidget';
import { initializeSecurity } from './src/lib/security';

type AuthState = 'initializing' | 'landing' | 'loggedOut' | 'loading' | 'loggedIn';

const App: React.FC = () => {
  const [authState, setAuthState] = useState<AuthState>('initializing');
  const [isChatOpen, setIsChatOpen] = useState(false);

  const handleEnterApp = () => {
    setAuthState('loggedOut');
  };

  const handleGoToLanding = () => {
    setAuthState('landing');
  };

  const handleLoginSuccess = () => {
    setAuthState('loading');
  };
  
  const handleLogout = () => {
    setAuthState('loggedOut');
  };

  useEffect(() => {
    // Initialize security measures on app start
    initializeSecurity();

    if (authState === 'initializing') {
      // Check for existing authentication
      const accessToken = localStorage.getItem('dark_matter_access_token');
      const refreshToken = localStorage.getItem('dark_matter_refresh_token');
      
      if (accessToken && refreshToken) {
        // User has tokens, skip to main page
        setAuthState('loggedIn');
      } else {
        // No tokens, show landing page after splash
        const timer = setTimeout(() => {
          setAuthState('landing');
        }, 3000);
        return () => clearTimeout(timer);
      }
    }
    if (authState === 'loading') {
      const timer = setTimeout(() => {
        setAuthState('loggedIn');
      }, 3000); // Simulate loading for 3 seconds after login
      return () => clearTimeout(timer);
    }
  }, [authState]);

  const renderContent = () => {
    switch (authState) {
      case 'initializing':
      case 'loading':
        return <LoaderPage />;
      case 'landing':
        return <LandingPage onEnter={handleEnterApp} />;
      case 'loggedIn':
        return <MainPage onLogout={handleLogout} />;
      case 'loggedOut':
      default:
        return <LoginPage onLoginSuccess={handleLoginSuccess} onGoToLanding={handleGoToLanding} />;
    }
  };

  return (
    <ErrorBoundary>
      <div className="min-h-screen bg-black text-gray-300 font-mono">
        {renderContent()}`n        {/* Chat only available when logged in */}`n        {authState === 'loggedIn' && !isChatOpen && <ChatButton onClick={() => setIsChatOpen(true)} />}`n        {authState === 'loggedIn' && isChatOpen && <ChatWidget onClose={() => setIsChatOpen(false)} />}
      </div>
    </ErrorBoundary>
  );
};

export default App;
